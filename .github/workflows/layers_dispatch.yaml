name: Deploy Layers

on:
  push:
    branches:
      - master
  schedule:
    - cron: "0 0 * * *" # This will run the workflow daily at midnight

env:
  LAYER_NAME: lambda-layer-chrome-aws
  S3_BUCKET_NAME: ${{ secrets.S3_BUCKET_GITHUB_ARTIFACTS }}
  AWS_REGION: ${{ secrets.AWS_REGION  || 'eu-central-1' }}

jobs:
  sonarqube:
    name: SonarQube
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0 # Shallow clones should be disabled for a better relevancy of analysis
      - name: SonarQube Scan
        uses: SonarSource/sonarqube-scan-action@fd88b7d7ccbaefd23d8f36f73b59db7a3d246602
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

  check_release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Setup AWS CLI
        uses: aws-actions/configure-aws-credentials@00943011d9042930efac3dcd3a170e4273319bc8
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Get Previous Tag Version
        id: prev_tag_version
        run: echo "tag=$(cat .tag_version || echo '')" >> $GITHUB_OUTPUT

      - name: Get Latest Release URL and Tag Version
        id: latest_release
        run: |
          JSON_RESPONSE=$(curl -s https://api.github.com/repos/Sparticuz/chromium/releases/latest)
          LATEST_RELEASE_URL_X64=$(echo $JSON_RESPONSE | grep -Po '"browser_download_url": "\K[^"]+\.x64\.zip' | awk 'NR==1')
          LATEST_RELEASE_URL_ARM64=$(echo $JSON_RESPONSE | grep -Po '"browser_download_url": "\K[^"]+\.arm64\.zip' | awk 'NR==1')
          TAG_VERSION=$(echo $JSON_RESPONSE | grep -Po '"tag_name": "\K[^"]+')
          if [[ "$TAG_VERSION" == "${{ steps.prev_tag_version.outputs.tag }}" ]]; then
            echo "Skipping as the tag version is the same as the previous run."
            echo "tag_unchanged=true" >> $GITHUB_OUTPUT
          fi
          echo "LATEST_RELEASE_URL_X64=$LATEST_RELEASE_URL_X64" >> $GITHUB_ENV
          echo "LATEST_RELEASE_URL_ARM64=$LATEST_RELEASE_URL_ARM64" >> $GITHUB_ENV
          echo "TAG_VERSION=$TAG_VERSION" >> $GITHUB_ENV
          echo "FILENAME_X64=lambda-layer-chromium-$TAG_VERSION.x64.zip" >> $GITHUB_ENV
          echo "FILENAME_ARM64=lambda-layer-chromium-$TAG_VERSION.arm64.zip" >> $GITHUB_ENV

      - name: Update Tag Version
        if: steps.latest_release.outputs.tag_unchanged != 'true'
        run: echo ${{ env.TAG_VERSION }} > .tag_version

      - name: Download Latest X64 Release
        if: steps.latest_release.outputs.tag_unchanged != 'true'
        run: |
          curl -LO ${{ env.LATEST_RELEASE_URL_X64 }}
          FILEPATH=$(basename ${{ env.LATEST_RELEASE_URL_X64 }})
          echo "FILEPATH_X64=$FILEPATH" >> $GITHUB_ENV

      - name: Download Latest ARM64 Release
        if: steps.latest_release.outputs.tag_unchanged != 'true'
        run: |
          curl -LO ${{ env.LATEST_RELEASE_URL_ARM64 }}
          FILEPATH=$(basename ${{ env.LATEST_RELEASE_URL_ARM64 }})
          echo "FILEPATH_ARM64=$FILEPATH" >> $GITHUB_ENV

      - name: Upload x64 Release to S3
        if: steps.latest_release.outputs.tag_unchanged != 'true'
        run: |
          S3_URI="s3://${{ env.S3_BUCKET_NAME }}/${{ env.LAYER_NAME }}/${{ env.FILENAME_X64 }}"
          aws s3 cp ${{ env.FILEPATH_X64  }} ${S3_URI}
          echo "S3_URI_X64=${S3_URI}" >> $GITHUB_ENV

      - name: Upload arm64 Release to S3
        if: steps.latest_release.outputs.tag_unchanged != 'true'
        run: |
          S3_URI="s3://${{ env.S3_BUCKET_NAME }}/${{ env.LAYER_NAME }}/${{ env.FILENAME_ARM64 }}"
          aws s3 cp ${{ env.FILEPATH_ARM64  }} ${S3_URI}
          echo "S3_URI_ARM64=${S3_URI}" >> $GITHUB_ENV

      - name: Commit Tag Version
        if: steps.latest_release.outputs.tag_unchanged != 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add .tag_version
          git commit -m "Update tag version to ${{ env.TAG_VERSION }}"
          git push

      - name: Update README
        if: steps.latest_release.outputs.tag_unchanged != 'true'
        run: |
          TAG_VERSION=${{ env.TAG_VERSION }}
          sed -i -e "s|Has Chromium v[0-9\.]*|Has Chromium $TAG_VERSION|g" readme.md

      - name: Commit and Push README
        if: steps.latest_release.outputs.tag_unchanged != 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add readme.md
          git commit -m "Update README with new version details ${{ env.TAG_VERSION }}"
          git push
