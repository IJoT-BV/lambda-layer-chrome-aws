name: Deploy Layers

on:
  push:
    branches:
      - master
  schedule:
    - cron: "0 0 * * *" # This will run the workflow daily at midnight

env:
  LAYER_NAME: lambda-layer-chrome-aws
  S3_BUCKET_NAME: ${{ secrets.S3_BUCKET_GITHUB_ARTIFACTS }}
  AWS_REGION: ${{ secrets.AWS_REGION  || 'eu-central-1' }}
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

permissions:
  contents: write
  pull-requests: read

jobs:
  sonarqube:
    name: SonarQube
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0 # Shallow clones should be disabled for a better relevancy of analysis
      - name: SonarQube Scan
        uses: SonarSource/sonarqube-scan-action@fd88b7d7ccbaefd23d8f36f73b59db7a3d246602 # v3.0.0
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

  check_release:
    runs-on: ubuntu-latest
    needs: sonarqube

    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Setup AWS CLI
        uses: aws-actions/configure-aws-credentials@e3dd6a429d7300a6a4c196c26e071d42e0343502 # v4.0.2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Get Previous Tag Version
        id: prev_tag_version
        run: echo "tag=$(cat .tag_version || echo '')" >> $GITHUB_OUTPUT

      - name: Get Latest Release URL and Tag Version
        id: latest_release
        run: |
          JSON_RESPONSE=$(curl -s -H "Authorization: token ${{ env.GITHUB_TOKEN }}" https://api.github.com/repos/Sparticuz/chromium/releases/latest)
          LATEST_RELEASE_URL_X64=$(echo $JSON_RESPONSE | grep -Po '"browser_download_url": "\K[^"]+\.x64\.zip' | awk 'NR==1')
          LATEST_RELEASE_URL_ARM64=$(echo $JSON_RESPONSE | grep -Po '"browser_download_url": "\K[^"]+\.arm64\.zip' | awk 'NR==1')
          TAG_VERSION=$(echo $JSON_RESPONSE | grep -Po '"tag_name": "\K[^"]+')

          # Validate URLs were found
          if [[ -z "$LATEST_RELEASE_URL_X64" ]] || [[ -z "$LATEST_RELEASE_URL_ARM64" ]]; then
            echo "Error: Failed to extract download URLs"
            exit 1
          fi

          if [[ "$TAG_VERSION" == "${{ steps.prev_tag_version.outputs.tag }}" ]]; then
            echo "Skipping as the tag version is the same as the previous run."
            echo "tag_unchanged=true" >> $GITHUB_OUTPUT
          fi
          echo "LATEST_RELEASE_URL_X64=$LATEST_RELEASE_URL_X64" >> $GITHUB_ENV
          echo "LATEST_RELEASE_URL_ARM64=$LATEST_RELEASE_URL_ARM64" >> $GITHUB_ENV
          echo "TAG_VERSION=$TAG_VERSION" >> $GITHUB_ENV
          echo "FILENAME_X64=lambda-layer-chromium-$TAG_VERSION.x64.zip" >> $GITHUB_ENV
          echo "FILENAME_ARM64=lambda-layer-chromium-$TAG_VERSION.arm64.zip" >> $GITHUB_ENV

      - name: Download Latest X64 Release
        if: steps.latest_release.outputs.tag_unchanged != 'true'
        run: |
          curl -LO ${{ env.LATEST_RELEASE_URL_X64 }}
          FILEPATH=$(basename ${{ env.LATEST_RELEASE_URL_X64 }})
          echo "FILEPATH_X64=$FILEPATH" >> $GITHUB_ENV
          echo "ZIP_SIZE_X64=$(du -h $FILEPATH | cut -f1)" >> $GITHUB_ENV

      - name: Download Latest ARM64 Release
        if: steps.latest_release.outputs.tag_unchanged != 'true'
        run: |
          curl -LO ${{ env.LATEST_RELEASE_URL_ARM64 }}
          FILEPATH=$(basename ${{ env.LATEST_RELEASE_URL_ARM64 }})
          echo "FILEPATH_ARM64=$FILEPATH" >> $GITHUB_ENV
          echo "ZIP_SIZE_ARM64=$(du -h $FILEPATH | cut -f1)" >> $GITHUB_ENV

      - name: Upload x64 Release to S3
        if: steps.latest_release.outputs.tag_unchanged != 'true'
        run: |
          S3_URI="s3://${{ env.S3_BUCKET_NAME }}/${{ env.LAYER_NAME }}/${{ env.FILENAME_X64 }}"
          aws s3 cp ${{ env.FILEPATH_X64  }} ${S3_URI}
          echo "S3_URI_X64=${S3_URI}" >> $GITHUB_ENV

      - name: Upload arm64 Release to S3
        if: steps.latest_release.outputs.tag_unchanged != 'true'
        run: |
          S3_URI="s3://${{ env.S3_BUCKET_NAME }}/${{ env.LAYER_NAME }}/${{ env.FILENAME_ARM64 }}"
          aws s3 cp ${{ env.FILEPATH_ARM64  }} ${S3_URI}
          echo "S3_URI_ARM64=${S3_URI}" >> $GITHUB_ENV

      - name: Update Version Files
        if: steps.latest_release.outputs.tag_unchanged != 'true'
        run: |
          echo ${{ env.TAG_VERSION }} > .tag_version
          TAG_VERSION=${{ env.TAG_VERSION }}
          sed -i -e "s|Uses Chromium v[0-9\.]*|Uses Chromium $TAG_VERSION|g" readme.md
          sed -i -e "s|lambda-layer-chromium-v[0-9\.]*\.x64\.zip|lambda-layer-chromium-$TAG_VERSION.x64.zip|g" readme.md
          sed -i -e "s|lambda-layer-chromium-v[0-9\.]*\.arm64\.zip|lambda-layer-chromium-$TAG_VERSION.arm64.zip|g" readme.md

      - name: Commit and Push Changes
        if: steps.latest_release.outputs.tag_unchanged != 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add .tag_version readme.md
          git commit -m "Update to Chromium ${{ env.TAG_VERSION }}"
          git push

      - name: Create GitHub Release (optional)
        if: steps.latest_release.outputs.tag_unchanged != 'true'
        uses: softprops/action-gh-release@6da8fa9354ddfdc4aeace5fc48d7f679b5214090 # v2.2.0
        with:
          tag_name: v${{ github.run_number }}
          name: ${{ env.LAYER_NAME }} v${{ env.TAG_VERSION}}.${{ github.run_number }}
          body: |
            ## ${{ env.LAYER_NAME }}

            **Size (x64):** ${{ env.ZIP_SIZE_X64 }}
            **Size (arm64):** ${{ env.ZIP_SIZE_ARM64 }}
            **S3 Location (x64):** ${{ env.S3_URI_X64 }}
            **S3 Location (arm64):** `${{ env.S3_URI_ARM64 }}`
            **AWS Region:** ${{ env.AWS_REGION }}

          files: |
            ${{ env.FILENAME_X64 }}
            ${{ env.FILENAME_ARM64 }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
